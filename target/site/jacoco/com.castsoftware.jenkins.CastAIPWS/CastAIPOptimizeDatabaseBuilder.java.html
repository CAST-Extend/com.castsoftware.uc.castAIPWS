<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CastAIPOptimizeDatabaseBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CAST Jenkins Plugin</a> &gt; <a href="index.source.html" class="el_package">com.castsoftware.jenkins.CastAIPWS</a> &gt; <span class="el_source">CastAIPOptimizeDatabaseBuilder.java</span></div><h1>CastAIPOptimizeDatabaseBuilder.java</h1><pre class="source lang-java linenums">package com.castsoftware.jenkins.CastAIPWS;

import hudson.EnvVars;
import hudson.Launcher;
import hudson.model.BuildListener;
import hudson.model.AbstractBuild;
import hudson.tasks.Builder;

import java.io.IOException;
import java.text.ParseException;
import java.util.Calendar;

import javax.xml.rpc.ServiceException;

import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.StaplerRequest;

import com.castsoftware.batch.CastWebService;
import com.castsoftware.batch.CastWebServiceServiceLocator;
import com.castsoftware.exception.HelperException;
import com.castsoftware.jenkins.CastAIPWS.CastAIPBuilder.DescriptorImpl;
import com.castsoftware.jenkins.CastAIPWS.util.Constants;
import com.castsoftware.jenkins.CastAIPWS.util.Utils;

/**
 * Sample {@link Builder}.
 *
 * &lt;p&gt;
 * When the user configures the project and enables this builder,
 * {@link DescriptorImpl#newInstance(StaplerRequest)} is invoked and a new
 * {@link CastAIPOptimizeDatabaseBuilder} is created. The created instance is persisted to
 * the project configuration XML by using XStream, so this allows you to use
 * instance fields (like {@link #name}) to remember the configuration.
 *
 * &lt;p&gt;
 * When a build is performed, the
 * {@link #perform(AbstractBuild, Launcher, BuildListener)} method will be
 * invoked.
 *
 * @author Nevin Kaplan
 */
public class CastAIPOptimizeDatabaseBuilder extends Builder
{
	// Fields in config.jelly must match the parameter names in the
	// &quot;DataBoundConstructor&quot;
	@DataBoundConstructor
	public CastAIPOptimizeDatabaseBuilder()
<span class="nc" id="L48">	{</span>
<span class="nc" id="L49">	}</span>
	
	@SuppressWarnings(&quot;rawtypes&quot;)
	@Override
	public boolean perform(AbstractBuild build, Launcher launcher, BuildListener listener) throws IOException, InterruptedException
	{
<span class="nc" id="L55">		long startTime = System.nanoTime();</span>
<span class="nc" id="L56">		boolean retCode = true;</span>
		int taskId;
<span class="nc" id="L58">		EnvVars envVars = build.getEnvironment(listener);</span>

		int startAt;
		try {
<span class="nc" id="L62">			startAt = Integer.parseInt(envVars.get(Constants.START_AT));</span>
<span class="nc" id="L63">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L64">			startAt=0;</span>
<span class="nc" id="L65">		}</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (startAt &gt; Constants.RunDatabaseOptimize) {</span>
<span class="nc" id="L67">			listener.getLogger().println(&quot; &quot;);</span>
<span class="nc" id="L68">			listener.getLogger().println(String.format(&quot;${START_AT} = %d, skipping run snapshot step.&quot;, startAt));</span>
		} else {
<span class="nc" id="L70">			listener.getLogger().println(&quot; &quot;);</span>
<span class="nc" id="L71">			listener.getLogger().println(&quot;CAST Database Optimization&quot;);</span>

<span class="nc" id="L73">			String castDate = envVars.get(Constants.CAST_DATE);</span>
<span class="nc" id="L74">			String webServiceAddress = envVars.get(Constants.CMS_WEB_SERVICE_ADDRESS);</span>
<span class="nc" id="L75">			String castSchemaPrefix = envVars.get(Constants.SCHEMA_PREFIX);</span>
<span class="nc" id="L76">			String appName = envVars.get(Constants.APPLICATION_NAME);</span>
<span class="nc" id="L77">			String verName = envVars.get(Constants.VERSION_NAME);</span>

<span class="nc" id="L79">			CastWebServiceServiceLocator cbwsl = new CastWebServiceServiceLocator();</span>
<span class="nc" id="L80">			cbwsl.setCastWebServicePortEndpointAddress(webServiceAddress);</span>
			try {
<span class="nc" id="L82">				CastWebService cbws = cbwsl.getCastWebServicePort();</span>
				
<span class="nc bnc" id="L84" title="All 2 branches missed.">				if (!Utils.validateWebServiceVersion(webServiceAddress, listener)) {</span>
<span class="nc" id="L85">					return false;</span>
				}
				
<span class="nc" id="L88">				Calendar cal = Utils.convertCastDate(castDate);</span>
				
<span class="nc" id="L90">				taskId = cbws.runOptimization(castSchemaPrefix, appName, verName, cal);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">				if (taskId &lt; 0) {</span>
<span class="nc" id="L92">					listener.getLogger().println(String.format(&quot;Error: %s&quot;, cbws.getErrorMessage(-taskId)));</span>
<span class="nc" id="L93">					return false;</span>
				}

<span class="nc bnc" id="L96" title="All 2 branches missed.">				if (!Utils.getLog(cbws, taskId, startTime, listener)) {</span>
<span class="nc" id="L97">					return false;</span>
				}
				
<span class="nc" id="L100">			} catch (ServiceException | HelperException | ParseException e) {</span>
<span class="nc" id="L101">				listener.getLogger().println(</span>
						String.format(&quot;%s error accured while backing up the tripplet&quot;, e.getMessage()));
<span class="nc" id="L103">			}</span>

		}
		//are there any remaining steps to run, if so run them now
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (!Utils.runJobs(build, launcher, listener, this.getClass(), Constants.RunDatabaseOptimize))</span>
		{
<span class="nc" id="L109">			return false;</span>
		}
<span class="nc" id="L111">		return retCode; </span>
	}

	public static boolean isWindows()
	{
<span class="nc bnc" id="L116" title="All 2 branches missed.">		return (System.getProperty(&quot;os.name&quot;).toLowerCase().indexOf(&quot;win&quot;) &gt;= 0);</span>
	}

	// Overridden for better type safety.
	// If your plugin doesn't really define any property on Descriptor,
	// you don't have to do this.
//	@Override
//	public DescriptorImpl getDescriptor()
//	{
//		return (DescriptorImpl) super.getDescriptor();
//	}

	/**
	 * Descriptor for {@link CastAIPOptimizeDatabaseBuilder}. Used as a singleton. The
	 * class is marked as public so that it can be accessed from views.
	 *
	 * &lt;p&gt;
	 * See
	 * &lt;tt&gt;src/main/resources/hudson/plugins/hello_world/CastAIPCSSBackupBuilder/*.jelly&lt;/tt&gt;
	 * for the actual HTML fragment for the configuration screen.
	 */
//	@Extension
//	// This indicates to Jenkins that this is an implementation of an extension
//	// point.
//	public static final class DescriptorImpl extends BuildStepDescriptor&lt;Builder&gt;
//	{
//		private boolean useCleanup;
//		private int duration;
//
//		// private boolean deleteLogFiles;
//		/**
//		 * In order to load the persisted global configuration, you have to call
//		 * load() in the constructor.
//		 */
//		public DescriptorImpl()
//		{
//			load();
//		}
//
//		/**
//		 * Performs on-the-fly validation of the form field 'name'.
//		 *
//		 * @param value
//		 *            This parameter receives the value that the user has typed.
//		 * @return Indicates the outcome of the validation. This is sent to the
//		 *         browser.
//		 *         &lt;p&gt;
//		 *         Note that returning {@link FormValidation#error(String)} does
//		 *         not prevent the form from being saved. It just means that a
//		 *         message will be displayed to the user.
//		 */
//		public FormValidation doCheckName(@QueryParameter String value) throws IOException, ServletException
//		{
//			if (value.length() == 0) return FormValidation.error(&quot;Please set a name&quot;);
//			if (value.length() &lt; 4) return FormValidation.warning(&quot;Isn't the name too short?&quot;);
//			return FormValidation.ok();
//		}
//
//		public boolean isApplicable(@SuppressWarnings(&quot;rawtypes&quot;) Class&lt;? extends AbstractProject&gt; aClass)
//		{
//			// Indicates that this builder can be used with all kinds of project
//			// types
//			return true;
//		}
//
//		/**
//		 * This human readable name is used in the configuration screen.
//		 */
//		public String getDisplayName()
//		{
//			return String.format(&quot;CAST AIP %d: Optimize CAST Database&quot;, Constants.RunDatabaseOptimize)  ;
//		}
//
//		@Override
//		public boolean configure(StaplerRequest req, JSONObject formData) throws FormException
//		{
//
//			final JSONObject cleanupJSON = formData.getJSONObject(&quot;useCleanup&quot;);
//			if ((cleanupJSON != null) &amp;&amp; !(cleanupJSON.isNullObject())) {
//				this.useCleanup = true;
//				this.duration = cleanupJSON.getInt(&quot;duration&quot;);
//				// this.deleteLogFiles=cleanupJSON.getBoolean(&quot;deleteLogFiles&quot;);
//
//			} else {
//				this.useCleanup = false;
//			}
//
//			save();
//			return super.configure(req, formData);
//		}
//
//		public boolean getUseCleanup()
//		{
//			return useCleanup;
//		}
//
//		public int getDuration()
//		{
//			return duration;
//		}
//
//		/**
//		 * public boolean getDeleteLogFiles() { return deleteLogFiles; }
//		 **/
//		/****
//		 * public ListBoxModel doFillOppTypeItems() { return new ListBoxModel(
//		 * new Option(&quot;Backup&quot;,&quot;B&quot;, true), new Option(&quot;Restore&quot;,&quot;R&quot;, false));
//		 * 
//		 * }
//		 ****/
//
//	}
	/** end DescriptorImpl **/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>