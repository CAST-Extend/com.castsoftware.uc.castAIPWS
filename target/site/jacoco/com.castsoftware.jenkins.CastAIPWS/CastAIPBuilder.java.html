<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CastAIPBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CAST Jenkins Plugin</a> &gt; <a href="index.source.html" class="el_package">com.castsoftware.jenkins.CastAIPWS</a> &gt; <span class="el_source">CastAIPBuilder.java</span></div><h1>CastAIPBuilder.java</h1><pre class="source lang-java linenums">package com.castsoftware.jenkins.CastAIPWS;

import java.io.IOException;
import java.rmi.RemoteException;
import java.text.ParseException;
import java.util.Collection;
import java.util.Date;
import java.util.logging.ConsoleHandler;
import java.util.logging.LogManager;
import java.util.logging.Logger;

import javax.servlet.ServletException;
import javax.xml.rpc.ServiceException;
import javax.xml.soap.SOAPException;

import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.QueryParameter;
import org.kohsuke.stapler.StaplerRequest;

import com.castsoftware.batch.CastWebService;
import com.castsoftware.batch.CastWebServiceServiceLocator;
import com.castsoftware.exception.HelperException;
import com.castsoftware.jenkins.CastAIPWS.CastAIPBuilder.DescriptorImpl;
import com.castsoftware.jenkins.CastAIPWS.util.AdBlock;
import com.castsoftware.jenkins.CastAIPWS.util.ArchiveBlock;
import com.castsoftware.jenkins.CastAIPWS.util.BackupBlock;
import com.castsoftware.jenkins.CastAIPWS.util.Constants;
import com.castsoftware.jenkins.CastAIPWS.util.OptimizeBlock;
import com.castsoftware.jenkins.CastAIPWS.util.PublishBlock;
import com.castsoftware.jenkins.CastAIPWS.util.RaBlock;
import com.castsoftware.jenkins.CastAIPWS.util.RsBlock;
import com.castsoftware.jenkins.CastAIPWS.util.RsvBlock;
import com.castsoftware.jenkins.CastAIPWS.util.Utils;
import com.castsoftware.jenkins.util.EnvTemplater;
import com.castsoftware.jenkins.util.PublishEnvVarAction;
import com.castsoftware.profiles.ConnectionProfile;
import com.castsoftware.util.CastUtil;
import com.castsoftware.util.VersionInfo;
import com.castsoftware.vps.ValidationProbesService;
import com.castsoftware.webservice.RemoteHelper;

import hudson.EnvVars;
import hudson.Extension;
import hudson.Launcher;
import hudson.model.AbstractBuild;
import hudson.model.AbstractProject;
import hudson.model.BuildListener;
import hudson.tasks.BuildStepDescriptor;
import hudson.tasks.Builder;
import hudson.util.FormValidation;
import hudson.util.*;
import net.sf.json.JSONObject;

public class CastAIPBuilder extends Builder
{
	private final String dmtWebServiceAddress;
	private final String cmsWebServiceAddress;
	private final String appName;
	private final String versionName;
	private final String referenceVersion;
	private final String castMSConnectionProfile;
	private final String schemaPrefix;
	private final String aadSchemaName;
	private final String retentionPolicy;
	private String lastRunDate;

	private final boolean backup;
	private final boolean da;
	private final boolean ad;
	private final boolean ra;
	private final boolean rs;
	private final boolean archive;
	private final boolean rav;
	private final boolean publish;
	private final boolean optimize;
	private final boolean useJnlp;

	// private final String snapshotName;
	// private final String captureDate;
	private final String workFlow;

	// Fields in config.jelly must match the parameter names in the
	// &quot;DataBoundConstructor&quot;
	@DataBoundConstructor
	public CastAIPBuilder(String dmtWebServiceAddress, String cmsWebServiceAddress, String appName,
			String referenceVersion, String versionName, String castMSConnectionProfile, BackupBlock backupBlock,
			AdBlock daBlock, AdBlock adBlock, RaBlock raBlock, RsBlock rsBlock, RsvBlock ravBlock,
			PublishBlock publishBlock, ArchiveBlock archiveBlock, OptimizeBlock optimizeBlock, String workFlow,
			String schemaPrefix, String aadSchemaName, String lastRunDate, String retentionPolicy, boolean useJnlp)
<span class="nc" id="L90">	{</span>
<span class="nc" id="L91">		this.dmtWebServiceAddress = dmtWebServiceAddress;</span>
<span class="nc" id="L92">		this.cmsWebServiceAddress = cmsWebServiceAddress;</span>
<span class="nc" id="L93">		this.appName = appName;</span>
<span class="nc" id="L94">		this.versionName = versionName;</span>
<span class="nc" id="L95">		this.referenceVersion = referenceVersion;</span>
<span class="nc" id="L96">		this.castMSConnectionProfile = castMSConnectionProfile;</span>
<span class="nc" id="L97">		this.schemaPrefix = schemaPrefix;</span>
<span class="nc" id="L98">		this.aadSchemaName = aadSchemaName;</span>
<span class="nc" id="L99">		this.workFlow = workFlow;</span>
<span class="nc" id="L100">		this.lastRunDate = lastRunDate;</span>
		
<span class="nc" id="L102">		this.useJnlp=useJnlp;</span>
		
		// Publish snapshot
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (backupBlock != null) {</span>
<span class="nc" id="L106">			this.backup = true;</span>
		} else {
<span class="nc" id="L108">			this.backup = false;</span>
		}

		// Deliver Code
<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (daBlock != null) {</span>
<span class="nc" id="L113">			this.da = true;</span>
		} else {
<span class="nc" id="L115">			this.da = false;</span>
		}

		// Accept Delivery
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (adBlock != null) {</span>
<span class="nc" id="L120">			this.ad = true;</span>
		} else {
<span class="nc" id="L122">			this.ad = false;</span>
		}

		// Run Analysis
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (raBlock != null) {</span>
<span class="nc" id="L127">			this.ra = true;</span>
		} else {
<span class="nc" id="L129">			this.ra = false;</span>
		}

		// Run Snapshot
<span class="nc bnc" id="L133" title="All 2 branches missed.">		if (rsBlock != null) {</span>
<span class="nc" id="L134">			this.retentionPolicy=retentionPolicy;</span>
<span class="nc" id="L135">			this.rs = true;</span>
		} else {
<span class="nc" id="L137">			this.retentionPolicy=&quot;&quot;;</span>
<span class="nc" id="L138">			this.rs = false;</span>
		}

		// Run Analysis Validation
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (ravBlock != null) {</span>
<span class="nc" id="L143">			this.rav = true;</span>
		} else {
<span class="nc" id="L145">			this.rav = false;</span>
		}

		// Publish snapshot
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (publishBlock != null) {</span>
<span class="nc" id="L150">			this.publish = true;</span>
		} else {
<span class="nc" id="L152">			this.publish = false;</span>
		}

		// Publish snapshot
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (optimizeBlock != null) {</span>
<span class="nc" id="L157">			this.optimize = true;</span>
		} else {
<span class="nc" id="L159">			this.optimize = false;</span>
		}

		// Archive Delivery
<span class="nc bnc" id="L163" title="All 2 branches missed.">		if (archiveBlock != null) {</span>
<span class="nc" id="L164">			this.archive = true;</span>
		} else {
<span class="nc" id="L166">			this.archive = false;</span>
		}
<span class="nc" id="L168">	}</span>

	public boolean isUseJnlp()
	{
<span class="nc" id="L172">		return useJnlp;</span>
	}
	
	private Boolean checkWebServiceCompatibility(String version)
	{
<span class="nc" id="L177">		return Constants.wsVersionCompatibility.equals(version);</span>
	}

	public String getDmtWebServiceAddress()
	{
<span class="nc" id="L182">		return dmtWebServiceAddress;</span>
	}

	public String getCmsWebServiceAddress()
	{
<span class="nc" id="L187">		String retVal = &quot;&quot;;</span>
<span class="nc bnc" id="L188" title="All 4 branches missed.">		if (cmsWebServiceAddress == null || cmsWebServiceAddress.isEmpty()) {</span>
<span class="nc" id="L189">			retVal = dmtWebServiceAddress;</span>
		} else {
<span class="nc" id="L191">			retVal = cmsWebServiceAddress;</span>
		}
<span class="nc" id="L193">		return retVal;</span>
	}

	public String getAadSchemaName()
	{
<span class="nc" id="L198">		return aadSchemaName;</span>
	}

	public String getSchemaPrefix()
	{
<span class="nc" id="L203">		return schemaPrefix.toLowerCase();</span>
	}

	public String getAppName()
	{
<span class="nc" id="L208">		return appName;</span>
	}

	public String getVersionName()
	{
<span class="nc" id="L213">		return versionName;</span>
	}

	public String getReferenceVersion()
	{
<span class="nc" id="L218">		return referenceVersion;</span>
	}

	public String getCastMSConnectionProfile()
	{
<span class="nc" id="L223">		return castMSConnectionProfile;</span>
	}

	public boolean isBackup()
	{
<span class="nc" id="L228">		return backup;</span>
	}

	public boolean isDa()
	{
<span class="nc" id="L233">		return da;</span>
	}

	public boolean isAaws()
	{
<span class="nc" id="L238">		return da;</span>
	}

	public boolean isOptimize()
	{
<span class="nc" id="L243">		return optimize;</span>
	}

	public boolean isAd()
	{
<span class="nc" id="L248">		return ad;</span>
	}

	public boolean isRa()
	{
<span class="nc" id="L253">		return ra;</span>
	}

	public boolean isRs()
	{
<span class="nc" id="L258">		return rs;</span>
	}

	public boolean isRav()
	{
<span class="nc" id="L263">		return rav;</span>
	}

	public boolean isArchive()
	{
<span class="nc" id="L268">		return archive;</span>
	}

	public String getRetentionPolicy()
	{
<span class="nc bnc" id="L273" title="All 2 branches missed.">		return retentionPolicy==null?&quot;&quot;:retentionPolicy;</span>
	}

	public boolean isPublish()
	{
<span class="nc" id="L278">		return publish;</span>
	}

	public String getVersionNameWithTag(Date date, EnvVars envVars)
	{
<span class="nc" id="L283">		String s = versionName.replace(&quot;[TODAY]&quot;, Constants.dateFormatVersion.format(date));</span>
<span class="nc" id="L284">		EnvTemplater jEnv = new EnvTemplater(envVars);</span>
<span class="nc" id="L285">		s = jEnv.templateString(s);</span>

<span class="nc" id="L287">		return s;</span>
	}

	public String getWorkFlow()
	{
<span class="nc" id="L292">		return workFlow;</span>
	}

//	public ListBoxModel doFillAppNameItems(@QueryParameter(&quot;dmtWebServiceAddress&quot;) final String webServiceAddress)
//	{
//		ListBoxModel m = new ListBoxModel();
//
//		try {
//			Collection&lt;String&gt; apps = RemoteHelper.listApplications(webServiceAddress);
//
//			for (String app : apps) {
//				m.add(app);
//			}
//
//		} catch (HelperException e) {
//			return m;
//		}
//		return m;
//	}

//	public ListBoxModel doFillCastMSConnectionProfileItems(
//			@QueryParameter(&quot;cmsWebServiceAddress&quot;) final String webServiceAddress)
//	{
//		ListBoxModel m = new ListBoxModel();
//
//		List&lt;String&gt; logNames = (List&lt;String&gt;) LogManager.getLogManager().getLoggerNames();
//
//		try {
//			Collection&lt;ConnectionProfile&gt; cpList = RemoteHelper.listConnectionProfiles(webServiceAddress);
//
//			for (ConnectionProfile cp : cpList) {
//				m.add(cp.getName(), cp.getName());
//			}
//
//		} catch (HelperException e) {
//			return m;
//		}
//		return m;
//	}
	
	@SuppressWarnings(&quot;rawtypes&quot;)
	public boolean publishVariables(AbstractBuild build, BuildListener listener, String castDate) throws IOException,
			InterruptedException
	{
<span class="nc" id="L336">		boolean rslt = true;</span>
		Date dateForToday;
		try {
<span class="nc" id="L339">			EnvVars envVars = build.getEnvironment(listener);</span>
<span class="nc" id="L340">			dateForToday = Utils.convertCastDate(castDate).getTime();</span>

<span class="nc" id="L342">			String snapshotName = &quot;Computed on &quot; + Constants.dateFormatVersion.format(dateForToday);</span>

<span class="nc" id="L344">			build.addAction(new PublishEnvVarAction(Constants.CAST_DATE, castDate));</span>
<span class="nc" id="L345">			build.addAction(new PublishEnvVarAction(Constants.DMT_WEB_SERVICE_ADDRESS, getDmtWebServiceAddress()));</span>
<span class="nc" id="L346">			build.addAction(new PublishEnvVarAction(Constants.CMS_WEB_SERVICE_ADDRESS, getCmsWebServiceAddress()));</span>
<span class="nc" id="L347">			build.addAction(new PublishEnvVarAction(Constants.APPLICATION_NAME, getAppName()));</span>
<span class="nc" id="L348">			build.addAction(new PublishEnvVarAction(Constants.VERSION_NAME,</span>
					getVersionNameWithTag(dateForToday, envVars)));
<span class="nc" id="L350">			build.addAction(new PublishEnvVarAction(Constants.AAD_SCHEMA_NAME, getAadSchemaName()));</span>
<span class="nc" id="L351">			build.addAction(new PublishEnvVarAction(Constants.SCHEMA_PREFIX, getSchemaPrefix()));</span>
<span class="nc" id="L352">			build.addAction(new PublishEnvVarAction(Constants.CONNECTION_PROFILE, getCastMSConnectionProfile()));</span>
<span class="nc" id="L353">			build.addAction(new PublishEnvVarAction(Constants.SNAPSHOT_NAME, snapshotName));</span>

<span class="nc" id="L355">			build.addAction(new PublishEnvVarAction(Constants.RETENTION_POLICY, getRetentionPolicy()));</span>
			
<span class="nc" id="L357">			build.addAction(new PublishEnvVarAction(Constants.WORK_FLOW, getWorkFlow()));</span>
<span class="nc" id="L358">			build.addAction(new PublishEnvVarAction(Constants.REFERENCE_VERSION, getReferenceVersion()));</span>

			// build flags
<span class="nc" id="L361">			build.addAction(new PublishEnvVarAction(Constants.RUN_BACKUP, Boolean.toString(isBackup())));</span>
<span class="nc" id="L362">			build.addAction(new PublishEnvVarAction(Constants.RUN_DELIVERY_APPLICATION, Boolean.toString(isDa())));</span>
<span class="nc" id="L363">			build.addAction(new PublishEnvVarAction(Constants.RUN_ACCEPT_DELIVERY, Boolean.toString(isAd())));</span>
<span class="nc" id="L364">			build.addAction(new PublishEnvVarAction(Constants.RUN_ANALYSIS, Boolean.toString(isRa())));</span>
<span class="nc" id="L365">			build.addAction(new PublishEnvVarAction(Constants.RUN_SNAPSHOT, Boolean.toString(isRs())));</span>
<span class="nc" id="L366">			build.addAction(new PublishEnvVarAction(Constants.RUN_VALIDATION, Boolean.toString(isRav())));</span>
<span class="nc" id="L367">			build.addAction(new PublishEnvVarAction(Constants.RUN_PUBLISH_SNAPSHOT, Boolean.toString(isPublish())));</span>
<span class="nc" id="L368">			build.addAction(new PublishEnvVarAction(Constants.RUN_OPTIMIZE_DATABASE, Boolean.toString(isOptimize())));</span>
<span class="nc" id="L369">			build.addAction(new PublishEnvVarAction(Constants.RUN_ARCHIVE_DELIVERY, Boolean.toString(isArchive())));</span>
<span class="nc" id="L370">			build.addAction(new PublishEnvVarAction(Constants.RUN_JNLP_DELIVERY, Boolean.toString(isUseJnlp())));</span>
			
<span class="nc" id="L372">			rslt = Utils.validateBuildVariables(build, listener);</span>

<span class="nc" id="L374">		} catch (ParseException e) {</span>
<span class="nc" id="L375">			listener.error(&quot;Unable to publish CAST Enviroment Variables: %s&quot;, e.getMessage());</span>
<span class="nc" id="L376">			return false;</span>
<span class="nc" id="L377">		}</span>
<span class="nc" id="L378">		return rslt;</span>
	}

	public int getStartAt(AbstractBuild build, BuildListener listener)
	{
		try {
<span class="nc" id="L384">			EnvVars envVars = build.getEnvironment(listener);</span>
<span class="nc" id="L385">			return Integer.parseInt(envVars.get(Constants.START_AT));</span>
<span class="nc" id="L386">		} catch (NumberFormatException | IOException | InterruptedException e) {</span>
<span class="nc" id="L387">			return 0;</span>
		}

	}

	public String getLastRunDate()
	{
<span class="nc" id="L394">		return lastRunDate;</span>
	}
	public void setLastRunDate(String lastRunDate)
	{
<span class="nc" id="L398">		this.lastRunDate=lastRunDate;</span>
<span class="nc" id="L399">	}</span>

	@SuppressWarnings(&quot;rawtypes&quot;)
	@Override
	public boolean perform(AbstractBuild build, Launcher launcher, BuildListener listener) throws IOException,
			InterruptedException
	{
<span class="nc" id="L406">		long startTime = System.nanoTime();</span>
<span class="nc" id="L407">		EnvVars envVars = build.getEnvironment(listener);</span>

		// calculate castDate
<span class="nc" id="L410">		int startAt = getStartAt(build, listener);</span>
<span class="nc" id="L411">		String lastRunDate = getLastRunDate();</span>

<span class="nc" id="L413">		String castDate = envVars.get(Constants.CAST_DATE);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">		if (startAt &gt; 0) {</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">			if (castDate == null || castDate.isEmpty()) {</span>
<span class="nc bnc" id="L416" title="All 4 branches missed.">				if (lastRunDate == null || lastRunDate.isEmpty()) </span>
				{
<span class="nc" id="L418">					castDate = Constants.castDateFormat.format(new Date());				</span>
				} else {
<span class="nc" id="L420">					castDate = lastRunDate;									</span>
				}
			} else {
<span class="nc" id="L423">				lastRunDate = castDate;</span>
			}
		} else {
<span class="nc" id="L426">			castDate = Constants.castDateFormat.format(new Date());				</span>
<span class="nc" id="L427">			lastRunDate = castDate;</span>
		}
<span class="nc" id="L429">		setLastRunDate(lastRunDate);</span>
		
<span class="nc bnc" id="L431" title="All 2 branches missed.">		if (!publishVariables(build, listener, castDate)) {</span>
<span class="nc" id="L432">			return false;</span>
		}
<span class="nc" id="L434">		listener.getLogger().println(&quot;****CAST Application Inteligence Platform****&quot;);</span>

<span class="nc" id="L436">		listener.getLogger().println(String.format(&quot;START_AT: %d&quot;, startAt));</span>
<span class="nc" id="L437">		listener.getLogger().println(String.format(&quot;CAST_DATE: %s&quot;, castDate));</span>

<span class="nc" id="L439">		boolean failBuild = getWorkFlow().trim().toLowerCase().equals(&quot;no&quot;);</span>

<span class="nc" id="L441">		listener.getLogger().println(String.format(&quot;DMT Web Service Address:  %s&quot;, getDmtWebServiceAddress()));</span>
<span class="nc" id="L442">		listener.getLogger().println(String.format(&quot;CMS Web Service Address:  %s&quot;, getCmsWebServiceAddress()));</span>
		
		//Create Job list and run the first job
<span class="nc" id="L445">		CastWebServiceServiceLocator cbwsl = new CastWebServiceServiceLocator();</span>
<span class="nc" id="L446">		cbwsl.setCastWebServicePortEndpointAddress(getCmsWebServiceAddress());</span>
		try {
<span class="nc bnc" id="L448" title="All 2 branches missed.">			if (!Utils.validateWebServiceVersion(getCmsWebServiceAddress(), listener)) {</span>
<span class="nc" id="L449">				return false;</span>
			}

			//Send Jenkins Console location to AOP
<span class="nc" id="L453">			sendJenkinsConsolURL(build, listener, getAppName(),castDate);</span>
			
<span class="nc bnc" id="L455" title="All 2 branches missed.">			if (!Utils.runJobs(build, launcher, listener, this.getClass(), -1))</span>
			{
<span class="nc" id="L457">					return false || failBuild;</span>
			}
			
<span class="nc" id="L460">		} catch (RemoteException | InterruptedException | HelperException | UnsupportedOperationException e) {</span>
<span class="nc" id="L461">			listener.getLogger().println(</span>
					String.format(&quot;Interrupted after: %s\n%s: %s&quot;,
							CastUtil.formatNanoTime(System.nanoTime() - startTime), e.getClass().getName(),
							e.getMessage()));
<span class="nc" id="L465">			return false || failBuild;</span>
<span class="nc" id="L466">		}</span>
<span class="nc" id="L467">		return true;</span>
	}

	/**
	 *  Send Jenkins console location to AOP
	 * 
	 * @param build 
	 * @param listener
	 * @param appName
	 * @param castDate
	 */
	void sendJenkinsConsolURL(AbstractBuild build, BuildListener listener, String appName,String castDate)
	{
<span class="nc" id="L480">		String webServiceAddress = getCmsWebServiceAddress();</span>
		
<span class="nc" id="L482">		CastWebServiceServiceLocator cbwsl = new CastWebServiceServiceLocator();</span>
<span class="nc" id="L483">		cbwsl.setCastWebServicePortEndpointAddress(webServiceAddress);</span>
		
		try {
<span class="nc" id="L486">			CastWebService cbws = cbwsl.getCastWebServicePort();</span>
			
<span class="nc" id="L488">			String validateionProbURL = cbws.getValidationProbURL();</span>
<span class="nc bnc" id="L489" title="All 4 branches missed.">			if (validateionProbURL==null || validateionProbURL.isEmpty()) {</span>
<span class="nc" id="L490">				listener.getLogger().println(&quot;Warning: Connection to AOP is not configured - validation check has not been performed&quot;);</span>
			} else {	
<span class="nc" id="L492">				ValidationProbesService vps = new ValidationProbesService(validateionProbURL);</span>
				
<span class="nc" id="L494">				EnvVars envVars = build.getEnvironment(listener);</span>
<span class="nc" id="L495">				String jobName = envVars.get(&quot;JOB_NAME&quot;);</span>
<span class="nc" id="L496">				String buildNo = envVars.get(&quot;BUILD_NUMBER&quot;);</span>
<span class="nc" id="L497">				String consoleURL = String.format(&quot;job/%s/%s/console&quot;,jobName,buildNo);</span>
<span class="nc" id="L498">				vps.sendJenkinsConsolInfo(appName, castDate, consoleURL);</span>
				
			}
<span class="nc" id="L501">		} catch (ServiceException | UnsupportedOperationException | SOAPException | IOException | InterruptedException e) {</span>
<span class="nc" id="L502">			listener.getLogger().println(&quot;Error sending Jenkins console information to AOP&quot;);</span>
<span class="nc" id="L503">		}</span>
<span class="nc" id="L504">	}</span>
	

	// Overridden for better type safety.
	// If your plugin doesn't really define any property on Descriptor,
	// you don't have to do this.
	@Override
	public DescriptorImpl getDescriptor()
	{
<span class="nc" id="L513">		return (DescriptorImpl) super.getDescriptor();</span>
	}

	/**
	 * Descriptor for {@link CastAIPBuilder}. Used as a singleton. The class is
	 * marked as public so that it can be accessed from views.
	 *
	 * &lt;p&gt;
	 * See
	 * &lt;tt&gt;src/main/resources/hudson/plugins/hello_world/CastDMTBuilder/*.jelly&lt;/tt&gt;
	 * for the actual HTML fragment for the configuration screen.
	 */
	@Extension
	// This indicates to Jenkins that this is an implementation of an extension
	// point.
	public static final class DescriptorImpl extends BuildStepDescriptor&lt;Builder&gt;
	{
		public DescriptorImpl()
<span class="fc" id="L531">		{</span>
<span class="fc" id="L532">			load();</span>
<span class="fc" id="L533">		}</span>

		@SuppressWarnings(&quot;rawtypes&quot;)
		public boolean isApplicable(Class&lt;? extends AbstractProject&gt; aClass)
		{
			// Indicates that this builder can be used with all kinds of project
			// types
<span class="nc" id="L540">			return true;</span>
		}

		/**
		 * This human readable name is used in the configuration screen.
		 */
		public String getDisplayName()
		{
<span class="fc" id="L548">			return &quot;CAST AIP 0: Configuration&quot;;</span>
		}

		public FormValidation doTestConnection(
				@QueryParameter(&quot;dmtWebServiceAddress&quot;) final String dmtWebServiceAddress,
				@QueryParameter(&quot;cmsWebServiceAddress&quot;) String cmsWebServiceAddress) throws IOException,
				ServletException
		{
<span class="nc" id="L556">			boolean ok = true;</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">			if (dmtWebServiceAddress.isEmpty()) {</span>
<span class="nc" id="L558">				return FormValidation.error(&quot;Delivery Web Service Address must have a value!&quot;);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">			} else if (cmsWebServiceAddress.replaceAll(&quot;\t&quot;, &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L560">				cmsWebServiceAddress = dmtWebServiceAddress;</span>
			}

<span class="nc" id="L563">			StringBuffer returnMsg = new StringBuffer();</span>
			try {
<span class="nc" id="L565">				VersionInfo dvi = RemoteHelper.getVersionInfo(dmtWebServiceAddress);</span>
<span class="nc" id="L566">				returnMsg.append(String.format(&quot;Delivery Address Success (%s)\n&quot;, dvi.toString()));</span>
<span class="nc" id="L567">			} catch (HelperException e) {</span>
<span class="nc" id="L568">				returnMsg.append(String.format(&quot;Delivery Address Error %s\n&quot;, e.getMessage()));</span>
<span class="nc" id="L569">				ok = false;</span>
<span class="nc" id="L570">			}</span>
			try {
<span class="nc" id="L572">				VersionInfo dvi = RemoteHelper.getVersionInfo(cmsWebServiceAddress);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">				if (dvi.getVersion().equals(Constants.wsVersionCompatibility)) {</span>
<span class="nc" id="L574">					returnMsg.append(String.format(&quot;Analysis Address Success (%s)\n&quot;, dvi.toString()));</span>
				} else {
<span class="nc" id="L576">					returnMsg</span>
							.append(String
									.format(&quot;WARNING ****** CAST Batch Web Service Version is not supported by this plugin ******* (%s)\n&quot;,
											dvi.toString()));
<span class="nc" id="L580">					ok = false;</span>
				}
<span class="nc" id="L582">			} catch (HelperException e) {</span>
<span class="nc" id="L583">				returnMsg.append(String.format(&quot;Analysis Address Error %s&quot;, e.getMessage()));</span>
<span class="nc" id="L584">				ok = false;</span>
<span class="nc" id="L585">			}</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (ok) {</span>
<span class="nc" id="L588">				return FormValidation.ok(returnMsg.toString());</span>
			} else {
<span class="nc" id="L590">				return FormValidation.error(returnMsg.toString());</span>
			}

		}

		public ListBoxModel doFillReferenceVersionItems(
				@QueryParameter(&quot;cmsWebServiceAddress&quot;) final String cmsWebServiceAddress,
				@QueryParameter(&quot;appName&quot;) final String appName)
		{
<span class="nc" id="L599">			ListBoxModel m = new ListBoxModel();</span>
			
			try {
<span class="nc" id="L602">				Collection&lt;String&gt; versions = RemoteHelper.listVersions(cmsWebServiceAddress, appName);</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">				for (String version : versions) {</span>
<span class="nc" id="L605">					m.add(version);</span>
<span class="nc" id="L606">				}</span>

<span class="nc" id="L608">			} catch (HelperException e) {</span>
<span class="nc" id="L609">				return m;</span>
<span class="nc" id="L610">			}</span>
<span class="nc" id="L611">			return m;</span>
		}

		public ListBoxModel doFillCastMSConnectionProfileItems(
				@QueryParameter(&quot;dmtWebServiceAddress&quot;) final String dmtWebServiceAddress,
				@QueryParameter(&quot;cmsWebServiceAddress&quot;) final String cmsWebServiceAddress)
		{
<span class="nc" id="L618">			Logger log = LogManager.getLogManager().getLogger(Logger.GLOBAL_LOGGER_NAME);</span>
<span class="nc" id="L619">			log.addHandler(new ConsoleHandler());</span>
<span class="nc" id="L620">			log.entering(getClass().getName(), String.format(</span>
					&quot;doFillCastMSConnectionProfileItems (dmtWebServiceAddress&lt;%s&gt;)&quot;, cmsWebServiceAddress));

<span class="nc" id="L623">			ListBoxModel m = new ListBoxModel();</span>

			try {
<span class="nc bnc" id="L626" title="All 4 branches missed.">				String webServiceAddress =  (cmsWebServiceAddress==null||cmsWebServiceAddress.isEmpty())?dmtWebServiceAddress:cmsWebServiceAddress;</span>

<span class="nc" id="L628">				Collection&lt;ConnectionProfile&gt; cpList = RemoteHelper.listConnectionProfiles(webServiceAddress);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">				for (ConnectionProfile cp : cpList) {</span>
<span class="nc" id="L630">					m.add(cp.getName(), cp.getName());</span>
<span class="nc" id="L631">				}</span>

<span class="nc" id="L633">			} catch (HelperException e) {</span>
<span class="nc" id="L634">				return m;</span>
<span class="nc" id="L635">			}</span>
<span class="nc" id="L636">			return m;</span>
		}
		
		public ListBoxModel doFillRetentionPolicyItems(@QueryParameter String retentionPolicy) 
		{
<span class="nc" id="L641">			ListBoxModel m = new ListBoxModel(</span>
					new ListBoxModel.Option(&quot;--None--&quot;,&quot;&quot;,retentionPolicy.matches(&quot;&quot;)),
					new ListBoxModel.Option(&quot;Monthly&quot;,&quot;12&quot;,retentionPolicy.matches(&quot;12&quot;))
//					new ListBoxModel.Option(&quot;Quarterly&quot;,&quot;4&quot;,retentionPolicy.matches(&quot;4&quot;)),
//					new ListBoxModel.Option(&quot;Every 6 Months&quot;,&quot;2&quot;,retentionPolicy.matches(&quot;2&quot;))
					);
<span class="nc" id="L647">			return m;</span>
		}

		public ListBoxModel doFillAppNameItems(@QueryParameter(&quot;cmsWebServiceAddress&quot;) final String webServiceAddress, @QueryParameter(&quot;status&quot;) String status)
		{
<span class="nc" id="L652">			ListBoxModel m = new ListBoxModel();</span>
			
			try {
<span class="nc" id="L655">				Collection&lt;String&gt; apps = RemoteHelper.listApplications(webServiceAddress);</span>

<span class="nc bnc" id="L657" title="All 2 branches missed.">				for (String app : apps) {</span>
<span class="nc" id="L658">					m.add(app);</span>
<span class="nc" id="L659">				}</span>
				
<span class="nc" id="L661">			} catch (HelperException e) {</span>
<span class="nc" id="L662">				return m;</span>
<span class="nc" id="L663">			}</span>
<span class="nc" id="L664">			return m;</span>
		}

		@Override
		public boolean configure(StaplerRequest req, JSONObject formData) throws FormException
		{
<span class="nc" id="L670">			save();</span>
<span class="nc" id="L671">			return super.configure(req, formData);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>